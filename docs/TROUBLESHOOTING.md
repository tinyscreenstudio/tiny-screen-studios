# Troubleshooting Guide

This guide helps you resolve common issues when using Tiny Screen Studios.

## Table of Contents

- [Installation Issues](#installation-issues)
- [File Processing Errors](#file-processing-errors)
- [Dimension and Format Issues](#dimension-and-format-issues)
- [Performance Problems](#performance-problems)
- [Canvas and Preview Issues](#canvas-and-preview-issues)
- [Export and Integration Issues](#export-and-integration-issues)
- [Browser Compatibility](#browser-compatibility)
- [Development and Build Issues](#development-and-build-issues)

## Installation Issues

### Node.js Version Compatibility

**Problem:** Installation fails with Node.js version errors.

**Solution:**
```bash
# Check your Node.js version
node --version

# Tiny Screen Studios requires Node.js 18+
# Update Node.js if needed
nvm install 18
nvm use 18

# Or download from https://nodejs.org/
```

### pnpm Installation Issues

**Problem:** `pnpm` commands not working or installation fails.

**Solution:**
```bash
# Install pnpm globally
npm install -g pnpm

# Or use npx
npx pnpm install

# Alternative: use npm instead
npm install
npm run dev
```

### TypeScript Compilation Errors

**Problem:** TypeScript errors during installation or build.

**Solution:**
```bash
# Ensure TypeScript is installed
pnpm add -D typescript

# Check tsconfig.json configuration
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "ESNext",
    "moduleResolution": "node",
    "strict": true,
    "esModuleInterop": true,
    "allowSyntheticDefaultImports": true,
    "skipLibCheck": true
  }
}

# Clean and rebuild
pnpm clean
pnpm build
```

## File Processing Errors

### "Unsupported file format" Error

**Problem:** Error when uploading files that appear to be PNG.

**Diagnosis:**
```bash
# Check actual file type
file your-image.png
# Should show: PNG image data

# Check file extension and MIME type
```

**Solution:**
- Ensure files are actual PNG format (not renamed JPG/GIF)
- Re-save images as PNG in image editor
- Check for corrupted files

```typescript
// Validate file type before processing
function validatePngFile(file: File): boolean {
  return file.type === 'image/png' && file.name.toLowerCase().endsWith('.png');
}

const validFiles = files.filter(validatePngFile);
if (validFiles.length !== files.length) {
  console.warn('Some files are not valid PNG format');
}
```

### "Dimension mismatch" Error

**Problem:** Images don't match the selected display preset dimensions.

**Diagnosis:**
```bash
# Check image dimensions
identify your-image.png
# Or
file your-image.png
```

**Solution:**
```typescript
import { DEVICE_PRESETS } from '@tiny-screen-studios/core';

// Check expected dimensions
const preset = 'SSD1306_128x64';
const expected = DEVICE_PRESETS[preset];
console.log(`Expected: ${expected.width}Ã—${expected.height}`);

// Resize images to match
// Use image editor or programmatic resizing
```

### "Files not in sequence" Warning

**Problem:** PNG sequence has gaps or incorrect naming.

**Correct naming pattern:**
```
frame_001.png
frame_002.png
frame_003.png
// NOT: frame_1.png, frame_3.png (missing frame_2.png)
```

**Solution:**
```bash
# Rename files to correct sequence
for i in {1..10}; do
  mv "frame_$i.png" "frame_$(printf '%03d' $i).png"
done
```

### Memory Errors with Large Files

**Problem:** Browser crashes or "out of memory" errors.

**Solution:**
```typescript
// Process files in smaller batches
async function processLargeFileSet(files: File[]) {
  const batchSize = 10;
  const results = [];
  
  for (let i = 0; i < files.length; i += batchSize) {
    const batch = files.slice(i, i + batchSize);
    const batchResults = await processFiles(batch, preset);
    results.push(...batchResults);
    
    // Allow garbage collection
    await new Promise(resolve => setTimeout(resolve, 100));
  }
  
  return results;
}
```

## Dimension and Format Issues

### Wrong Display Output

**Problem:** Generated bytes don't work correctly on hardware.

**Diagnosis checklist:**
1. Verify display preset matches your hardware
2. Check bit order (LSB-top vs MSB-top)
3. Verify page order and column order
4. Check polarity (normal vs inverted)

**Solution:**
```typescript
// Test different packing options
const testOptions = [
  { preset: 'SSD1306_128x64', bitOrder: 'lsb-top' },
  { preset: 'SSD1306_128x64', bitOrder: 'msb-top' },
  { preset: 'SSD1306_128x64', bitOrder: 'lsb-top', invert: true }
];

for (const options of testOptions) {
  const packed = packFrames(monoFrames, options);
  console.log(`Testing: ${JSON.stringify(options)}`);
  // Test on hardware
}
```

### SH1106 Display Issues

**Problem:** SH1106 display shows incorrect output or offset.

**Solution:**
```typescript
// SH1106 has 132 columns but only 128 are visible
// Ensure you're using the correct preset
const packedFrames = packFrames(monoFrames, {
  preset: 'SH1106_132x64'  // Not SSD1306_128x64
});

// The library automatically handles the 2-pixel offset
// Columns 0-1 and 130-131 are not visible
```

### Custom Display Integration

**Problem:** Need to support a display not included in presets.

**Solution:**
```typescript
// Define custom display configuration
const customDisplay = {
  width: 96,
  height: 16,
  pageHeight: 8,
  bitOrder: 'lsb-top' as const,
  pageOrder: 'top-down' as const,
  columnOrder: 'left-right' as const
};

// Implement custom packing function
function packCustomDisplay(frames: FrameMono[]): PackedFrame[] {
  // See advanced-usage.md for complete implementation
}
```

## Performance Problems

### Slow Processing Speed

**Problem:** Image processing takes too long.

**Diagnosis:**
```typescript
// Measure processing time
console.time('processing');
const result = await processFiles(files, preset);
console.timeEnd('processing');
```

**Solutions:**

1. **Reduce image size:**
```typescript
// Process smaller images when possible
const maxDimension = 128;
if (image.width > maxDimension || image.height > maxDimension) {
  // Resize image before processing
}
```

2. **Disable dithering for speed:**
```typescript
const monoFrames = toMonochrome(rgbaFrames, {
  dithering: 'none'  // Faster than 'bayer4'
});
```

3. **Use Web Workers:**
```typescript
// For large batches, use Web Workers
const workerManager = new WorkerManager();
const frames = await workerManager.processFiles(files, preset);
```

### High Memory Usage

**Problem:** Browser uses too much memory or crashes.

**Solutions:**

1. **Process files individually:**
```typescript
const results = [];
for (const file of files) {
  const result = await processFiles([file], preset);
  results.push(result);
  
  // Allow garbage collection
  if (typeof window !== 'undefined' && (window as any).gc) {
    (window as any).gc();
  }
}
```

2. **Clear references:**
```typescript
let rgbaFrames = await decodeImageFiles(files);
let monoFrames = toMonochrome(rgbaFrames);

// Clear intermediate results
rgbaFrames = null;

let packedFrames = packFrames(monoFrames);
monoFrames = null;
```

### Browser Freezing

**Problem:** UI becomes unresponsive during processing.

**Solution:**
```typescript
// Use requestAnimationFrame to yield control
async function processWithYield<T>(
  items: T[],
  processor: (item: T) => Promise<any>
): Promise<any[]> {
  const results = [];
  
  for (let i = 0; i < items.length; i++) {
    results.push(await processor(items[i]));
    
    // Yield control every 10 items
    if (i % 10 === 0) {
      await new Promise(resolve => requestAnimationFrame(resolve));
    }
  }
  
  return results;
}
```

## Canvas and Preview Issues

### Blurry Canvas Rendering

**Problem:** Canvas preview appears blurry or smoothed.

**Solution:**
```typescript
// Ensure image smoothing is disabled
const ctx = canvas.getContext('2d');
ctx.imageSmoothingEnabled = false;
ctx.webkitImageSmoothingEnabled = false;
ctx.mozImageSmoothingEnabled = false;
ctx.msImageSmoothingEnabled = false;

// Use integer scaling factors
renderFrameToCanvas(ctx, frame, {
  scale: 4  // Use 2, 4, 8, etc. - avoid fractional scales
});
```

### Canvas Size Issues

**Problem:** Canvas doesn't display correctly or is wrong size.

**Solution:**
```typescript
// Set canvas size correctly
const frame = packedFrames[0];
const scale = 4;

canvas.width = frame.dims.width * scale;
canvas.height = frame.dims.height * scale;

// Also set CSS size if needed
canvas.style.width = `${frame.dims.width * scale}px`;
canvas.style.height = `${frame.dims.height * scale}px`;
```

### Animation Playback Issues

**Problem:** Animation doesn't play smoothly or at correct speed.

**Solution:**
```typescript
// Ensure proper FPS calculation
const controller = playFramesOnCanvas(ctx, frames, {
  fps: 10,  // Reasonable FPS for smooth playback
  loop: true
});

// Check frame timing
frames.forEach((frame, index) => {
  console.log(`Frame ${index}: ${frame.delayMs}ms delay`);
});
```

## Export and Integration Issues

### Generated C Code Doesn't Compile

**Problem:** C compiler errors with generated code.

**Common issues and solutions:**

1. **Missing includes:**
```c
#include <stdint.h>  // For uint8_t
#include <avr/pgmspace.h>  // For PROGMEM (Arduino)
```

2. **Symbol name conflicts:**
```typescript
// Use unique symbol names
const cCode = toCRawArray(frames, 'my_unique_bitmap_name');
```

3. **Array size issues:**
```c
// Ensure array size matches expectations
const uint8_t bitmap[] = { /* data */ };
const int bitmap_size = sizeof(bitmap);  // Should match expected size
```

### Arduino Integration Problems

**Problem:** Display shows garbage or nothing.

**Diagnosis checklist:**
1. Verify display wiring and I2C address
2. Check display initialization
3. Verify bitmap dimensions match display
4. Test with simple pattern first

**Solution:**
```cpp
// Test with simple pattern first
void testDisplay() {
  display.clearDisplay();
  
  // Draw simple pattern
  for (int x = 0; x < 128; x += 8) {
    display.drawPixel(x, 0, WHITE);
    display.drawPixel(x, 63, WHITE);
  }
  
  display.display();
  delay(2000);
  
  // Then try your bitmap
  display.clearDisplay();
  display.drawBitmap(0, 0, your_bitmap, 128, 64, WHITE);
  display.display();
}
```

### Binary File Issues

**Problem:** Binary files don't work with firmware.

**Solution:**
```typescript
// Verify binary file size
const expectedSize = (width * height) / 8;
console.log(`Expected size: ${expectedSize} bytes`);
console.log(`Actual size: ${binaryFile.data.length} bytes`);

// Check byte order if needed
const bytes = Array.from(binaryFile.data);
console.log(`First few bytes: ${bytes.slice(0, 8).map(b => '0x' + b.toString(16)).join(', ')}`);
```

## Browser Compatibility

### File API Issues

**Problem:** File upload doesn't work in older browsers.

**Solution:**
```typescript
// Check for File API support
if (!window.File || !window.FileReader || !window.FileList || !window.Blob) {
  alert('File APIs are not fully supported in this browser.');
  return;
}

// Fallback for older browsers
function readFileAsArrayBuffer(file: File): Promise<ArrayBuffer> {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result as ArrayBuffer);
    reader.onerror = () => reject(reader.error);
    reader.readAsArrayBuffer(file);
  });
}
```

### Canvas API Issues

**Problem:** Canvas rendering doesn't work correctly.

**Solution:**
```typescript
// Check for Canvas support
const canvas = document.createElement('canvas');
if (!canvas.getContext) {
  alert('Canvas is not supported in this browser.');
  return;
}

const ctx = canvas.getContext('2d');
if (!ctx) {
  alert('2D canvas context is not available.');
  return;
}
```

### Web Worker Issues

**Problem:** Web Workers not supported or failing.

**Solution:**
```typescript
// Check for Web Worker support
if (typeof Worker === 'undefined') {
  console.warn('Web Workers not supported, falling back to main thread');
  // Use regular processing instead
}

// Handle Web Worker errors
worker.onerror = (error) => {
  console.error('Web Worker error:', error);
  // Fall back to main thread processing
};
```

## Development and Build Issues

### Import/Export Errors

**Problem:** Module import errors in TypeScript/JavaScript.

**Solution:**
```typescript
// Use correct import syntax
import { 
  decodeImageFiles, 
  toMonochrome, 
  packFrames 
} from '@tiny-screen-studios/core';

// For CommonJS environments
const { decodeImageFiles } = require('@tiny-screen-studios/core');

// Check package.json exports
{
  "exports": {
    ".": {
      "import": "./dist/index.js",
      "types": "./dist/index.d.ts"
    }
  }
}
```

### Build Configuration Issues

**Problem:** Vite/Webpack build fails.

**Solution:**
```javascript
// vite.config.js
export default {
  optimizeDeps: {
    include: ['@tiny-screen-studios/core']
  },
  build: {
    target: 'es2020'  // Ensure modern JS features are supported
  }
};

// webpack.config.js
module.exports = {
  resolve: {
    extensions: ['.ts', '.js'],
    fallback: {
      // Add polyfills if needed for Node.js modules
      "buffer": require.resolve("buffer/"),
      "stream": require.resolve("stream-browserify")
    }
  }
};
```

### Type Definition Issues

**Problem:** TypeScript can't find type definitions.

**Solution:**
```json
// tsconfig.json
{
  "compilerOptions": {
    "moduleResolution": "node",
    "esModuleInterop": true,
    "allowSyntheticDefaultImports": true,
    "skipLibCheck": true
  },
  "include": [
    "src/**/*",
    "node_modules/@tiny-screen-studios/core/dist/*.d.ts"
  ]
}
```

## Getting Help

If you're still experiencing issues after trying these solutions:

1. **Check the GitHub Issues:** [https://github.com/yourusername/tiny-screen-studios/issues](https://github.com/yourusername/tiny-screen-studios/issues)

2. **Create a minimal reproduction:**
```typescript
// Provide a minimal example that demonstrates the issue
const files = [/* minimal test case */];
const result = await processFiles(files, 'SSD1306_128x64');
console.log('Issue occurs here:', result);
```

3. **Include environment information:**
```bash
# Node.js version
node --version

# Package version
npm list @tiny-screen-studios/core

# Browser information (if applicable)
# Chrome 120.0.0.0, Firefox 121.0, etc.
```

4. **Provide error details:**
- Full error message and stack trace
- Steps to reproduce
- Expected vs actual behavior
- Sample files (if safe to share)

5. **Check browser console:**
- Open Developer Tools (F12)
- Look for errors in Console tab
- Check Network tab for failed requests

Remember to search existing issues before creating a new one, and provide as much detail as possible to help us help you!